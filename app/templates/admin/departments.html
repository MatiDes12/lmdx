{% extends 'admin/base.html' %}

{% block title %}Department Management{% endblock %}

{% block sidebar %}
{% include 'admin/sidebar.html' %}
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Stylish Header -->
    <div class="bg-gradient-to-r from-green-400 to-blue-500 p-8 rounded-xl shadow-2xl mb-10">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="bg-white p-3 rounded-full mr-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5 9 6.343 9 8s1.343 3 3 3zM12 13c-2.21 0-4 1.79-4 4v1h8v-1c0-2.21-1.79-4-4-4z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-4xl font-extrabold text-white mb-2">Department Management</h2>
                    <p class="text-white text-xl opacity-80">Manage all departments within your healthcare system</p>
                </div>
            </div>
            <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                <p class="text-white font-semibold">Total Departments: {{ total_departments }}</p>
            </div>
        </div>
    </div>

    <!-- Filter section with updated style -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-8 rounded-lg shadow-lg mb-8">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-3xl font-bold text-white">Filter Departments</h3>
            <button id="addDepartmentBtn" class="bg-white hover:bg-gray-100 text-blue-600 font-bold py-2 px-5 rounded-full flex items-center shadow-lg transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Add New Department
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="flex-1">
                <label for="searchDepartment" class="block text-sm font-medium text-white mb-2">Search Departments</label>
                <input type="text" id="searchDepartment" oninput="searchDepartment(this.value)" class="block w-full px-4 py-3 rounded-lg bg-white bg-opacity-90 border-0 focus:ring-2 focus:ring-blue-400 text-gray-900 placeholder-gray-500 shadow-md transition duration-300" placeholder="Search by department name...">
            </div>
            <div class="flex-1">
                <label for="departmentFilter" class="block text-sm font-medium text-white mb-2">Filter by Department Head</label>
                <select id="departmentFilter" onchange="filterByHead(this.value)" class="block w-full px-4 py-3 rounded-lg bg-white bg-opacity-90 border-0 focus:ring-2 focus:ring-blue-400 text-gray-900 shadow-md appearance-none cursor-pointer transition duration-300">
                    <option value="">All Heads</option>
                    {% for department in departments %}
                    <option value="{{ department.head }}">{{ department.head }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Department List Section -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <div class="overflow-x-auto">
            <table class="min-w-full leading-normal">
                <thead>
                    <tr>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Department Name</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Department Head</th>
                        <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="departmentTableBody">
                    {% if departments %}
                        {% for department in departments %}
                        <tr>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ department.name }}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ department.head }}</td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <button onclick="editDepartment({{ department.department_id }})" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                                <form action="{{ url_for('admin.admin_delete_department', department_id=department.department_id) }}" method="POST" style="display:inline;">
                                    <button type="submit" class="text-red-600 hover:text-red-900" onclick="return confirm('Are you sure you want to delete this department?');">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="3" class="px-5 py-5 border-b border-gray-200 bg-white text-sm text-center text-gray-500">
                                No departments found. Please add a department.
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Department Modal -->
    <div id="addDepartmentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Add New Department</h3>
                <form action="{{ url_for('admin.admin_add_department') }}" method="POST" class="space-y-4 mt-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Department Name</label>
                        <input type="text" id="name" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="head" class="block text-sm font-medium text-gray-700">Department Head</label>
                        <input type="text" id="head" name="head" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <div>
                        <button type="submit" class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Add Department
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Department Modal -->
    <div id="editDepartmentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Edit Department</h3>
                <form id="editDepartmentForm" action="" method="POST" class="space-y-4 mt-4">
                    <div>
                        <label for="edit_name" class="block text-sm font-medium text-gray-700">Department Name</label>
                        <input type="text" id="edit_name" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="edit_head" class="block text-sm font-medium text-gray-700">Department Head</label>
                        <input type="text" id="edit_head" name="head" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </div>
                    <div>
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Update Department
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Staff Assignment Section -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h3 class="text-2xl font-semibold mb-4">Staff Assignment</h3>
        <form id="staffAssignmentForm" class="space-y-4" action="{{ url_for('admin.admin_assign_staff') }}" method="POST">
            <div>
                <label for="departmentSelect" class="block text-sm font-medium text-gray-700">Select Department</label>
                <select id="departmentSelect" name="department" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    {% for department in departments %}
                    <option value="{{ department.department_id }}">{{ department.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="staffSelect" class="block text-sm font-medium text-gray-700">Assign Staff</label>
                <select id="staffSelect" name="staff" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    {% for staff in staff_members %}
                    <option value="{{ staff.staff_id }}">{{ staff.first_name }} {{ staff.last_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Assign Staff to Department
                </button>
            </div>
        </form>
        
    </div>

    <!-- Reports Section -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h3 class="text-2xl font-semibold mb-4">Generate Reports</h3>
        <form id="generateReportForm" class="space-y-4">
            <div>
                <label for="reportType" class="block text-sm font-medium text-gray-700">Select Report Type</label>
                <select id="reportType" name="report_type" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <option value="staff_assignment">Staff Assignment Report</option>
                    <option value="department_summary">Department Summary Report</option>
                </select>
            </div>
            <div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Generate Report
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById('addDepartmentBtn').addEventListener('click', function() {
        document.getElementById('addDepartmentModal').classList.remove('hidden');
    });

    function editDepartment(departmentId) {
        // Fetch department details and populate the form
        fetch(`/admin/departments/edit/${departmentId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('edit_name').value = data.name;
                document.getElementById('edit_head').value = data.head;
                document.getElementById('editDepartmentForm').action = `/admin/departments/edit/${departmentId}`;
                document.getElementById('editDepartmentModal').classList.remove('hidden');
            });
    }

    function closeModals() {
        document.getElementById('addDepartmentModal').classList.add('hidden');
        document.getElementById('editDepartmentModal').classList.add('hidden');
    }

    // Close modals when clicking outside of them
    window.onclick = function(event) {
        if (event.target === document.getElementById('addDepartmentModal')) {
            closeModals();
        }
        if (event.target === document.getElementById('editDepartmentModal')) {
            closeModals();
        }
    }

    document.getElementById('staffAssignmentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        // Implement staff assignment functionality
        console.log('Assigning staff to department');
    });

    document.getElementById('generateReportForm').addEventListener('submit', function(e) {
        e.preventDefault();
        // Implement report generation functionality
        console.log('Generating report');
    });

    document.getElementById('searchDepartment').addEventListener('input', function() {
        const searchValue = this.value.toLowerCase();
        const rows = document.querySelectorAll('#departmentTableBody tr');
        rows.forEach(row => {
            const departmentName = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
            if (departmentName.includes(searchValue)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}
