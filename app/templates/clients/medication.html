{% extends 'clients/base.html' %}
{% block navbar %}
    {% include 'clients/navbar.html' %}
{% endblock %}
{% block content %}
<div class="px-6 py-4 bg-gray-100 min-h-screen">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-4">
                {% for category, message in messages %}
                    <div class="p-4 mb-2 rounded-md 
                        {% if category == 'success' %}
                            bg-green-100 border border-green-400 text-green-700
                        {% elif category == 'danger' %}
                            bg-red-100 border border-red-400 text-red-700
                        {% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    <!-- Header Section -->
    <div class="bg-gradient-to-r from-green-400 via-blue-500 to-purple-600 p-6 rounded-lg mb-6 text-white">
        <h1 class="text-3xl font-bold">Your Medications</h1>
        <p>Manage all your medications, dosages, and schedules.</p>
    </div>

    <!-- Prescription List -->
    <div class="bg-white p-6 rounded-lg mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Prescriptions</h2>
        <table class="min-w-full divide-y divide-gray-200">
            <thead>
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medication</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dosage</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frequency</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Doctor</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% if prescriptions %}
                    {% for prescription in prescriptions %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 flex items-center">
                           <span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 48 48" fill="none" class="mr-2">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M24 21C27.5899 21 30.5 18.0899 30.5 14.5C30.5 10.9101 27.5899 8 24 8C20.4101 8 17.5 10.9101 17.5 14.5C17.5 18.0899 20.4101 21 24 21ZM24 23C28.6944 23 32.5 19.1944 32.5 14.5C32.5 9.80558 28.6944 6 24 6C19.3056 6 15.5 9.80558 15.5 14.5C15.5 19.1944 19.3056 23 24 23Z" fill="currentColor"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M24.3845 9.91006C24.9349 9.95616 25.3437 10.4397 25.2976 10.99L24.6955 18.1774C24.6494 18.7277 24.1659 19.1365 23.6155 19.0904C23.0652 19.0443 22.6564 18.5608 22.7025 18.0104L23.3046 10.8231C23.3507 10.2727 23.8342 9.86395 24.3845 9.91006Z" fill="currentColor"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M14.5 40C18.0899 40 21 37.0899 21 33.5C21 29.9101 18.0899 27 14.5 27C10.9101 27 8 29.9101 8 33.5C8 37.0899 10.9101 40 14.5 40ZM14.5 42C19.1944 42 23 38.1944 23 33.5C23 28.8056 19.1944 25 14.5 25C9.80558 25 6 28.8056 6 33.5C6 38.1944 9.80558 42 14.5 42Z" fill="currentColor"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M17.7571 36.7573C17.3666 37.1479 16.7335 37.1479 16.3429 36.7573L11.2429 31.6573C10.8524 31.2668 10.8524 30.6336 11.2429 30.2431C11.6335 29.8526 12.2666 29.8526 12.6571 30.2431L17.7571 35.3431C18.1477 35.7336 18.1477 36.3668 17.7571 36.7573Z" fill="currentColor"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M33.5 38C37.0899 38 40 35.0899 40 31.5C40 27.9101 37.0899 25 33.5 25C29.9101 25 27 27.9101 27 31.5C27 35.0899 29.9101 38 33.5 38ZM33.5 40C38.1944 40 42 36.1944 42 31.5C42 26.8056 38.1944 23 33.5 23C28.8056 23 25 26.8056 25 31.5C25 36.1944 28.8056 40 33.5 40Z" fill="currentColor"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M37.7588 29.745C37.9693 30.2556 37.7259 30.8401 37.2153 31.0506L30.5469 33.7987C30.0362 34.0091 29.4517 33.7658 29.2413 33.2551C29.0308 32.7445 29.2742 32.16 29.7848 31.9496L36.4532 29.2014C36.9639 28.991 37.5484 29.2344 37.7588 29.745Z" fill="currentColor"/>
                            </svg>
                           </span> {{ prescription.medication_id }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ prescription.dosage }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ prescription.frequency }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ prescription.start_date.strftime('%Y-%m-%d') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ prescription.end_date.strftime('%Y-%m-%d') }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ prescription.doctor.first_name }} {{ prescription.doctor.last_name }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No prescriptions found.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Medication Reminders and Schedule -->
    <div class="bg-gradient-to-br from-gray-100 to-gray-200 p-1 rounded-lg mb-6">
        <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-5 rounded-lg mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Medication Reminders</h2>
            <p class="text-gray-600">Set reminders for your medications to help you remember to take them on time.</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Today's Schedule -->
            <div class="bg-white rounded-2xl p-6 shadow-inner">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Today's Wellness Plan
                </h3>
                <div class="space-y-4">
                    {% for reminder in today_reminders %}
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-4 rounded-xl flex items-center justify-between transform transition-all duration-300 hover:scale-105 hover:shadow-md">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-gray-400 to-gray-500 rounded-full flex items-center justify-center text-white text-xl font-bold uppercase shadow-md hover:shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48" fill="none">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M24 21C27.5899 21 30.5 18.0899 30.5 14.5C30.5 10.9101 27.5899 8 24 8C20.4101 8 17.5 10.9101 17.5 14.5C17.5 18.0899 20.4101 21 24 21ZM24 23C28.6944 23 32.5 19.1944 32.5 14.5C32.5 9.80558 28.6944 6 24 6C19.3056 6 15.5 9.80558 15.5 14.5C15.5 19.1944 19.3056 23 24 23Z" fill="currentColor"/>
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M24.3845 9.91006C24.9349 9.95616 25.3437 10.4397 25.2976 10.99L24.6955 18.1774C24.6494 18.7277 24.1659 19.1365 23.6155 19.0904C23.0652 19.0443 22.6564 18.5608 22.7025 18.0104L23.3046 10.8231C23.3507 10.2727 23.8342 9.86395 24.3845 9.91006Z" fill="currentColor"/>
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M14.5 40C18.0899 40 21 37.0899 21 33.5C21 29.9101 18.0899 27 14.5 27C10.9101 27 8 29.9101 8 33.5C8 37.0899 10.9101 40 14.5 40ZM14.5 42C19.1944 42 23 38.1944 23 33.5C23 28.8056 19.1944 25 14.5 25C9.80558 25 6 28.8056 6 33.5C6 38.1944 9.80558 42 14.5 42Z" fill="currentColor"/>
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M17.7571 36.7573C17.3666 37.1479 16.7335 37.1479 16.3429 36.7573L11.2429 31.6573C10.8524 31.2668 10.8524 30.6336 11.2429 30.2431C11.6335 29.8526 12.2666 29.8526 12.6571 30.2431L17.7571 35.3431C18.1477 35.7336 18.1477 36.3668 17.7571 36.7573Z" fill="currentColor"/>
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M33.5 38C37.0899 38 40 35.0899 40 31.5C40 27.9101 37.0899 25 33.5 25C29.9101 25 27 27.9101 27 31.5C27 35.0899 29.9101 38 33.5 38ZM33.5 40C38.1944 40 42 36.1944 42 31.5C42 26.8056 38.1944 23 33.5 23C28.8056 23 25 26.8056 25 31.5C25 36.1944 28.8056 40 33.5 40Z" fill="currentColor"/>
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M37.7588 29.745C37.9693 30.2556 37.7259 30.8401 37.2153 31.0506L30.5469 33.7987C30.0362 34.0091 29.4517 33.7658 29.2413 33.2551C29.0308 32.7445 29.2742 32.16 29.7848 31.9496L36.4532 29.2014C36.9639 28.991 37.5484 29.2344 37.7588 29.745Z" fill="currentColor"/>
                                </svg>
                            </div>
                            <div>
                                <p class="font-semibold text-lg text-gray-800">{{ reminder.prescription.medication_id }}</p>
                                <p class="text-sm text-gray-600">{{ reminder.prescription.dosage }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-gray-600">{{ reminder.time.strftime('%I:%M %p') }}</p>
                            <div class="group relative mt-2 text-gray-500 text-sm flex items-center space-x-2">
                                <button class="mark-as-taken mt-2 bg-gradient-to-r from-gray-500 to-gray-600 text-white px-4 py-2 rounded-full text-sm hover:from-gray-600 hover:to-gray-700 transition-all duration-300 transform hover:scale-105"
                                    data-id="{{ reminder.reminder_id }}">
                                    Mark as Taken
                                </button>
                                <div class="group relative">
                                    <button class="repeat-reminder mt-2 bg-gradient-to-r from-gray-500 to-gray-600 text-white px-4 py-2 rounded-full text-sm hover:from-gray-600 hover:to-gray-700 transition-all duration-300 transform hover:scale-105"
                                        data-id="{{ reminder.reminder_id }}">
                                        Repeat
                                    </button>
                                    <div class="absolute right-0 top-0 bg-gray-100 p-2 rounded-lg shadow-md hidden group-hover:block">
                                        <p class="text-sm text-gray-600">Repeat: {{ reminder.repeat }}</p>
                                    </div>
                                </div>
                                <div>
                                    <form action="{{ url_for('patient.delete_reminder', reminder_id=reminder.reminder_id) }}" method="POST">
                                        <button type="submit" class="delete-reminder mt-2 bg-gradient-to-r from-gray-500 to-gray-600 text-white px-4 py-2 rounded-full text-sm hover:from-gray-600 hover:to-gray-700 transition-all duration-300 transform hover:scale-105"
                                            data-id="{{ reminder.reminder_id }}">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Set Reminders -->
            <div class="bg-white rounded-2xl p-6 shadow-inner">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Schedule New Reminder
                </h3>
                <form action="{{ url_for('patient.set_reminder') }}" method="POST" class="space-y-4">
                    <div class="relative">
                        <select name="prescription_id" class="w-full p-3 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent appearance-none transition-all duration-300">
                            <option value="" disabled selected>Choose your prescription</option>
                            {% for prescription in prescriptions %}
                            <option value="{{ prescription.prescription_id }}">{{ prescription.medication_id }}</option>
                            {% endfor %}
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="relative">
                        <input type="time" name="reminder_time" class="w-full p-3 bg-gradient-to-r from-gray-50 to-gray-100 border border-gray-200 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent transition-all duration-300">
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white py-3 px-4 rounded-lg hover:from-gray-600 hover:to-gray-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        Set New Reminder
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle Mark as Taken button
    document.querySelectorAll('.mark-as-taken').forEach(button => {
        button.addEventListener('click', function() {
            const reminderId = this.getAttribute('data-id');
            fetch(`/patient/mark_as_taken/${reminderId}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        this.innerHTML = '<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
                        this.classList.remove('bg-gradient-to-r', 'from-gray-500', 'to-gray-600');
                        this.classList.add('bg-green-500');
                        this.disabled = true;
                    }
                });
        });
    });

    // Handle Repeat button
    document.querySelectorAll('.repeat-reminder').forEach(button => {
        button.addEventListener('click', function() {
            const reminderId = this.getAttribute('data-id');
            fetch(`/patient/repeat_reminder/${reminderId}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        alert('Reminder set to repeat daily');
                    }
                });
        });
    });

    // Handle Delete button
    document.querySelectorAll('.delete-reminder').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const reminderId = this.getAttribute('data-id');
            fetch(`/patient/delete_reminder/${reminderId}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        this.closest('.bg-gradient-to-r').remove();
                    }
                });
        });
    });
});
</script>
{% endblock %}
