{% extends 'clients/base.html' %}
{% block navbar %}
    {% include 'clients/navbar.html' %}
{% endblock %}
{% block content %}
<div class="px-6 py-4 bg-gray-100 min-h-screen">
  <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 p-6 rounded-lg mb-6 text-white">
    <h1 class="text-3xl font-bold text-white">Your Messages</h1>
    <p class="text-white text-sm mt-2">Communicate with your healthcare providers securely and conveniently.</p>
  </div>
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2 bg-white p-6 rounded-lg mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Send a Message</h2>
      <form id="message-form">
        <div class="mb-6">
          <label for="doctor-select" class="block text-sm font-medium text-gray-700 mb-2">Choose your doctor:</label>
          <select id="doctor-select" name="doctor_id" class="w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg bg-gray-50 text-gray-700" required>
            <option value="">Select a doctor</option>
            {% for doctor in all_doctors  %}
              <option value="{{ doctor.doctor_id }}">{{ doctor.first_name }} {{ doctor.last_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div id="message-display" class="mb-6 bg-gray-50 p-4 rounded-lg h-64 overflow-y-auto">
          <!-- Message display area -->
        </div>
        <div class="mb-6">
          <label for="message" class="block text-sm font-medium text-gray-700 mb-2">Your Message:</label>
          <textarea id="message" name="message" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 mt-1 block w-full sm:text-sm border border-gray-300 rounded-lg p-4 bg-gray-50 h-24" placeholder="Type your message here..." required></textarea>
        </div>
        <button type="submit" class="w-full inline-flex items-center justify-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
          Send Message
          <svg class="ml-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
          </svg>
        </button>
      </form>
    </div>

    <div class="lg:col-span-1 bg-white p-6 rounded-lg mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Message History</h2>
      <div class="relative mb-4">
        <input type="text" id="search-messages" placeholder="Search messages..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>

      <div id="message-history" class="overflow-y-auto max-h-96 space-y-4">
        {% for doctor in unique_doctors %}
          <div class="message-preview p-4 bg-gray-100 rounded-lg cursor-pointer" data-doctor-id="{{ doctor['doctor_id'] }}">
            <p class="text-sm font-medium">{{ doctor['doctor_name'] }}</p>
            <p class="text-xs text-gray-400">{{ doctor['timestamp'] }}</p>
            <p class="text-sm text-gray-500">{{ doctor['last_message'] }}</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<style>
.message {
  max-width: 75%;
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 10px;
}
.sender-message {
  background-color: #f0f0f0;
  text-align: left;
  margin-right: auto;
  color: #333;
}
.receiver-message {
  background-color: #007bff;
  color: white;
  text-align: right;
  margin-left: auto;
}
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
      const messageHistoryContainer = document.getElementById('message-history');
  
      messageHistoryContainer.addEventListener('click', function(event) {
          const targetElement = event.target.closest('.message-preview[data-doctor-id]');
          if (targetElement) {
              const doctorId = targetElement.getAttribute('data-doctor-id');
              if (doctorId) {
                  loadConversation(doctorId);
                  selectDoctorInDropdown(doctorId); // Function to select the doctor in the dropdown
              } else {
                  alert("Doctor ID is undefined!");
              }
          }
      });
  
      function loadConversation(doctorId) {
          fetch(`/patient/get_messages?doctor_id=${doctorId}`)
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      const messageContainer = document.getElementById('message-display');
                      messageContainer.innerHTML = '';
                      data.conversation.forEach(msg => {
                          const messageElement = document.createElement('div');
                          messageElement.className = `message ${msg.sender === 'You' ? 'receiver-message' : 'sender-message'}`;
                          messageElement.innerHTML = `<p class="text-lg font-medium text-gray-800">${msg.sender}</p><p class="text-sm text-gray-600">${msg.message}</p><p class="text-xs text-gray-400">${msg.timestamp}</p>`;
                          messageContainer.appendChild(messageElement);
                      });
                  } else {
                      alert('Failed to load messages.');
                  }
              })
              .catch(error => {
                  console.error('Fetch error:', error);
                  alert('An error occurred. Please try again.');
              });
      }
  
      function selectDoctorInDropdown(doctorId) {
          const selectElement = document.getElementById('doctor-select');
          selectElement.value = doctorId;
      }
  });
  
  document.addEventListener('DOMContentLoaded', () => {
      const sender = '{{ session["user_id"] }}';
  
      document.getElementById('doctor-select').addEventListener('change', function() {
          const receiver = this.value;
          fetch(`/patient/get_messages?doctor_id=${receiver}`)
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      const messageContainer = document.getElementById('message-display');
                      messageContainer.innerHTML = '';
                      data.conversation.forEach(msg => {
                          const messageElement = document.createElement('div');
                          messageElement.className = `message ${msg.sender === 'You' ? 'receiver-message' : 'sender-message'}`;
                          messageElement.innerHTML = `<p class="text-lg font-medium text-gray-800">${msg.sender}</p><p class="text-sm text-gray-600">${msg.message}</p><p class="text-xs text-gray-400">${msg.timestamp}</p>`;
                          messageContainer.appendChild(messageElement);
                      });
                  } else {
                      alert('Failed to load messages.');
                  }
              });
      });
  
      document.getElementById('message-form').addEventListener('submit', (e) => {
          e.preventDefault();
          const messageInput = document.getElementById('message');
          const receiver = document.getElementById('doctor-select').value;
          const message = messageInput.value;
          if (message.trim() !== '') {
              fetch('/patient/send_message', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                      doctor_id: receiver,
                      message: message
                  })
              })
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      const messageContainer = document.getElementById('message-display');
                      const messageElement = document.createElement('div');
                      messageElement.className = 'message receiver-message';
                      messageElement.innerHTML = `<p class="text-lg font-medium text-gray-800">You</p><p class="text-sm text-gray-600">${message}</p>`;
                      messageContainer.appendChild(messageElement);
                      messageInput.value = '';
                      updateMessageHistory(receiver, message);  // Update message history
                  } else {
                      console.error('Error response:', data);
                      alert('Failed to send message. Please try again.');
                  }
              })
              .catch(error => {
                  console.error('Fetch error:', error);
                  alert('An error occurred. Please try again.');
              });
          }
      });
  
      function updateMessageHistory(doctorId, message) {
          // Find the corresponding doctor in the message history and update the last message
          const messagePreview = document.querySelector(`.message-preview[data-doctor-id="${doctorId}"]`);
          if (messagePreview) {
              messagePreview.querySelector('.text-sm.text-gray-500').textContent = message;
              messagePreview.querySelector('.text-xs.text-gray-400').textContent = new Date().toLocaleString();
          }
      }
  
      document.getElementById('search-messages').addEventListener('input', function() {
          const query = this.value.toLowerCase();
          document.querySelectorAll('.message-preview').forEach(function(message) {
              const doctorName = message.querySelector('.text-sm.font-medium').textContent.toLowerCase();
              const messageBody = message.querySelector('.text-sm.text-gray-500').textContent.toLowerCase();
              if (doctorName.includes(query) || messageBody.includes(query)) {
                  message.style.display = 'block';
              } else {
                  message.style.display = 'none';
              }
          });
      });
  });
  </script>
{% endblock %}
