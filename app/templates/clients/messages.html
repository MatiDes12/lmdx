{% extends 'clients/base.html' %}
{% block navbar %}
    {% include 'clients/navbar.html' %}
{% endblock %}
{% block content %}
<div class="px-6 py-4 bg-gray-100 min-h-screen">
  <!-- Stylish Header -->
  <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 p-6 rounded-lg mb-6 text-white">
    <h1 class="text-3xl font-bold text-white">Your Messages</h1>
    <p class="text-white text-sm mt-2">Communicate with your healthcare providers securely and conveniently.</p>
  </div>

  <!-- Main content grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Message Box -->
    <div class="lg:col-span-2 bg-white p-6 rounded-lg mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Send a Message</h2>
      <form id="message-form">
        <div class="mb-6">
          <label for="doctor-select" class="block text-sm font-medium text-gray-700 mb-2">Choose your doctor:</label>
          <select id="doctor-select" name="doctor_id" class="w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg bg-gray-50 text-gray-700" required>
            <option value="">Select a doctor</option>
            <!-- Doctor options will be dynamically loaded -->
          </select>
        </div>
        <div id="message-display" class="mb-6 bg-gray-50 p-4 rounded-lg h-64 overflow-y-auto">
          <!-- Message display area -->
        </div>
        <div class="mb-6">
          <label for="message" class="block text-sm font-medium text-gray-700 mb-2">Your Message:</label>
          <textarea id="message" name="message" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 mt-1 block w-full sm:text-sm border border-gray-300 rounded-lg p-4 bg-gray-50 h-24" placeholder="Type your message here..." required></textarea>
        </div>
        <button type="submit" class="w-full inline-flex items-center justify-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
          Send Message
          <svg class="ml-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
          </svg>
        </button>
      </form>
    </div>

    <!-- Message History -->
    <div class="lg:col-span-1 bg-white p-6 rounded-lg mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Message History</h2>
      <div class="relative mb-4">
        <input type="text" id="search-messages" placeholder="Search messages..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>
      <div id="message-history" class="overflow-y-auto max-h-96 space-y-4">
        <!-- Message history will be dynamically loaded -->
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const sender = 'patient1'; // Replace with dynamic sender ID
    const receiver = 'doctor1'; // Replace with dynamic receiver ID

    // Load existing messages
    fetch(`/get_messages?sender=${sender}&receiver=${receiver}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const messageContainer = document.getElementById('message-display');
                data.conversation.forEach(msg => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `message ${msg.sender === sender ? 'receiver-message' : 'sender-message'}`;
                    messageElement.innerHTML = `<p class="text-lg font-medium text-gray-800">${msg.sender === sender ? 'You' : receiver}</p><p class="text-sm text-gray-600">${msg.message}</p>`;
                    messageContainer.appendChild(messageElement);
                });
            } else {
                alert('Failed to load messages.');
            }
        });

    // Send message
    document.getElementById('message-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const messageInput = document.getElementById('message');
        const message = messageInput.value;
        if (message.trim() !== '') {
            fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sender: sender,
                    receiver: receiver,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const messageContainer = document.getElementById('message-display');
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message receiver-message';
                    messageElement.innerHTML = `<p class="text-lg font-medium text-gray-800">You</p><p class="text-sm text-gray-600">${message}</p>`;
                    messageContainer.appendChild(messageElement);
                    messageInput.value = '';
                } else {
                    alert('Failed to send message. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }
    });

    // Search functionality
    document.getElementById('search-messages').addEventListener('input', function() {
        const query = this.value.toLowerCase();
        document.querySelectorAll('.message-preview').forEach(function(message) {
            const doctorName = message.querySelector('.text-sm.font-medium').textContent.toLowerCase();
            const messageBody = message.querySelector('.text-sm.text-gray-500').textContent.toLowerCase();
            if (doctorName.includes(query) || messageBody.includes(query)) {
                message.style.display = 'block';
            } else {
                message.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}
