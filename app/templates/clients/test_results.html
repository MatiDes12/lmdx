{% extends 'clients/base.html' %}
{% block navbar %}
    {% include 'clients/navbar.html' %}
{% endblock %}
{% block content %}
<div class="px-6 py-4">
    <!-- Header Section -->
    <div class="bg-gradient-to-r from-green-400 via-blue-500 to-purple-600 p-6 rounded-lg shadow-lg mb-6 text-white">
        <h1 class="text-4xl font-bold">Lab Test Results</h1>
        <p>Access detailed results of your lab tests and track your health metrics over time.</p>
    </div>

    <!-- Filters for selecting test category and year -->
    <div class="flex gap-4 mb-6">
        <!-- Test Category Dropdown -->
        <div>
            <label for="test-category" class="block text-sm font-medium text-gray-700">Choose Test Category:</label>
            <select id="test-category" class="block w-full pl-3 pr-10 py-2 mt-1 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow bg-gray-50">
                <option value="all">All</option>
                <option value="Blood Work">Blood Work</option>
                <option value="Urine Analysis">Urine Analysis</option>
                <option value="Genetic Testing">Genetic Testing</option>
                <option value="Imaging Results">Imaging Results</option>
                <option value="Pathology Reports">Pathology Reports</option>
            </select>
        </div>

        <!-- Year Dropdown -->
        <div>
            <label for="year" class="block text-sm font-medium text-gray-700">Choose Year:</label>
            <select id="year" class="block w-full pl-3 pr-10 py-2 mt-1 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow bg-gray-50">
                <option value="all">All Years</option>
                {% for year in range(2025, 2019, -1) %}
                <option value="{{ year }}">{{ year }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Navigation for different test panels -->
    <div class="border-b-2 border-gray-200 mb-4">
        <div class="flex space-x-4 -mb-px text-sm" id="tabs">
            {% for result, test in test_results %}
            <button class="tabs focus:outline-none py-4 px-1 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-600" onclick="openTab(event, 'tab{{ loop.index }}')">{{ test.test_name }}</button>
            {% endfor %}
        </div>
    </div>

        <!-- Placeholder for no selection -->
        <div id="placeholder" class="flex flex-col items-center justify-center py-20">
            <svg xmlns="http://www.w3.org/2000/svg" height="70px" viewBox="0 -960 960 960" width="70px" fill="#6b7280">
                <path d="M160-200v-80h400v80H160Zm0-160v-80h640v80H160Zm0-160v-80h640v80H160Zm0-160v-80h640v80H160Z"/></svg>
            <p class="text-gray-500 text-lg">Please select a test category and year to view your lab test results.</p>
        </div>
    
        <!-- Navigation for different test panels -->
        <div class="border-b-2 border-gray-200 mb-4 hidden" id="tabs-container">
            <div class="flex space-x-4 -mb-px text-sm" id="tabs">
                {% for result, test in test_results %}
                <button class="tabs focus:outline-none py-4 px-1 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-600" onclick="openTab(event, 'tab{{ loop.index }}')">{{ test.test_name }}</button>
                {% endfor %}
            </div>
        </div>

    <!-- Tab Content -->
    {% for result, test in test_results %}
    <div id="tab{{ loop.index }}" class="tab-content hidden">
        <table class="min-w-full divide-y divide-gray-200 mt-4">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ test.test_name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ result.result_value }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ result.result_date.strftime('%Y-%m-%d') }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ result.notes }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% if result.image_path %}
                        <a href="#" onclick="showImageModal('{{ url_for('static', filename=result.image_path) }}')" class="text-blue-600 hover:text-blue-900">View Image</a>
                        {% else %}
                        <span class="text-gray-600">No Image</span>
                        {% endif %}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    {% endfor %}

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen">
            <div class="relative bg-white rounded-lg shadow-lg max-w-lg w-full">
                <div class="flex justify-end p-2">
                    <button onclick="closeImageModal()" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6">
                    <img id="modalImage" src="" alt="Lab Result Image" class="w-full h-auto rounded-lg">
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for handling tab functionality and image modal -->
    <script>
    function openTab(evt, tabName) {
        var i, tabcontent, tabs;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tabs = document.getElementsByClassName("tabs");
        for (i = 0; i < tabs.length; i++) {
            tabs[i].className = tabs[i].className.replace(" text-blue-600 border-blue-500", "");
            tabs[i].className += " border-transparent";
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " text-blue-600 border-blue-500";
    }

    // Automatically open the first tab
    document.addEventListener('DOMContentLoaded', function() {
        if (document.querySelector('.tab-content')) {
            document.querySelector('.tab-content').style.display = "block";
            if (document.querySelector('.tabs')) {
                document.querySelector('.tabs').className += " text-blue-600 border-blue-500";
            }
        }
    });

    // Show image in modal
    function showImageModal(imageUrl) {
        document.getElementById('modalImage').src = imageUrl;
        document.getElementById('imageModal').classList.remove('hidden');
    }

    // Close image modal
    function closeImageModal() {
        document.getElementById('imageModal').classList.add('hidden');
    }
    </script>
</div>
{% endblock %}
