{% extends 'doctors/base.html' %}

{% block title %}Messages{% endblock %}

{% block sidebar %}
{% include 'doctors/sidebar.html' %}
{% endblock %}

{% block navbar %}
{% include 'doctors/dashboard_navbar.html' %}
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-6 rounded-lg mb-6 text-white flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 48 48" fill="none" class="mr-4">
            <rect width="48" height="48" fill="none"/>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M26 33H29.5C36.4036 33 42 27.4036 42 20.5C42 13.5964 36.4036 8 29.5 8H18.5C11.5964 8 6 13.5964 6 20.5C6 28.4145 11.2167 33.2537 16.9239 36.2262C19.7585 37.7025 22.6136 38.6566 24.7728 39.2414C25.2149 39.3611 25.626 39.4649 26 39.5542V33ZM28 42C28 42 27.2439 41.8897 26 41.6077C20.2362 40.3007 4 35.305 4 20.5C4 12.4919 10.4919 6 18.5 6H29.5C37.5081 6 44 12.4919 44 20.5C44 28.5081 37.5081 35 29.5 35H28V42Z" fill="currentColor"/>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M24 22C24.5523 22 25 21.5523 25 21C25 20.4477 24.5523 20 24 20C23.4477 20 23 20.4477 23 21C23 21.5523 23.4477 22 24 22ZM24 24C25.6569 24 27 22.6569 27 21C27 19.3431 25.6569 18 24 18C22.3431 18 21 19.3431 21 21C21 22.6569 22.3431 24 24 24Z" fill="currentColor"/>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M32 22C32.5523 22 33 21.5523 33 21C33 20.4477 32.5523 20 32 20C31.4477 20 31 20.4477 31 21C31 21.5523 31.4477 22 32 22ZM32 24C33.6569 24 35 22.6569 35 21C35 19.3431 33.6569 18 32 18C30.3431 18 29 19.3431 29 21C29 22.6569 30.3431 24 32 24Z" fill="currentColor"/>
            <path fill-rule="evenodd" clip-rule="evenodd" d="M16 22C16.5523 22 17 21.5523 17 21C17 20.4477 16.5523 20 16 20C15.4477 20 15 20.4477 15 21C15 21.5523 15.4477 22 16 22ZM16 24C17.6569 24 19 22.6569 19 21C19 19.3431 17.6569 18 16 18C14.3431 18 13 19.3431 13 21C13 22.6569 14.3431 24 16 24Z" fill="currentColor"/>
        </svg>
        <div>
            <h1 class="text-3xl font-bold">Doctor's Messaging Center</h1>
            <p class="text-lg">Communicate securely with your patients</p>
        </div>
    </div>

    <div class="flex flex-col md:flex-row gap-6">
        <!-- Patient List -->
        <div class="w-full md:w-1/3 bg-white rounded-lg shadow-md p-4">
            <h2 class="text-xl font-semibold mb-4">Your Patients</h2>
            <div class="mb-4">
                <input type="text" id="patientSearch" placeholder="Search patients..." class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div id="patientList" class="space-y-2 max-h-[500px] overflow-y-auto">
                {% if patients %}
                    {% for patient in patients %}
                    <div class="flex items-center p-2 hover:bg-gray-100 rounded cursor-pointer" onclick="loadConversation({{ patient.id }})">
                        <img src="{{ patient.avatar }}" alt="{{ patient.name }}" class="w-10 h-10 rounded-full mr-3">
                        <div>
                            <p class="font-semibold">{{ patient.name }}</p>
                            <p class="text-sm text-gray-500">{{ patient.last_message_preview }}</p>
                        </div>
                        {% if patient.unread_messages > 0 %}
                        <span class="ml-auto bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">{{ patient.unread_messages }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-center text-gray-500">No patients found. Add patients to start messaging.</p>
                {% endif %}
            </div>
        </div>

        <!-- Message Area -->
        <div class="w-full md:w-2/3 bg-white rounded-lg shadow-md flex flex-col h-[600px]">
            {% if selected_patient %}
                <!-- Conversation Header -->
                <div class="p-4 border-b flex items-center justify-between">
                    <div class="flex items-center">
                        <img src="{{ selected_patient.avatar }}" alt="{{ selected_patient.name }}" class="w-10 h-10 rounded-full mr-3">
                        <div>
                            <p class="font-semibold">{{ selected_patient.name }}</p>
                            <p class="text-sm text-gray-500">{{ selected_patient.status }}</p>
                        </div>
                    </div>
                    <div>
                        <button class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500" onclick="scheduleAppointment({{ selected_patient.id }})">
                            Schedule Appointment
                        </button>
                    </div>
                </div>

                <!-- Message History -->
                <div id="messageHistory" class="flex-grow p-4 overflow-y-auto space-y-4">
                    {% for message in messages %}
                    <div class="flex {% if message.sender == 'doctor' %}justify-end{% endif %}">
                        <div class="max-w-xs md:max-w-md {% if message.sender == 'doctor' %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-800{% endif %} rounded-lg p-3">
                            <p>{{ message.content }}</p>
                            <p class="text-xs text-right mt-1 {% if message.sender == 'doctor' %}text-blue-200{% else %}text-gray-500{% endif %}">{{ message.timestamp }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Message Input -->
                <div class="p-4 border-t">
                    <form id="messageForm" class="flex items-center">
                        <input type="text" id="messageInput" placeholder="Type your message..." class="flex-grow p-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="bg-blue-500 text-white p-2 rounded-r-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </form>
                </div>
            {% else %}
                <div class="flex-grow flex items-center justify-center">
                    <div class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        <p class="text-xl font-semibold text-gray-600">Select a patient to start messaging</p>
                        <p class="text-gray-500 mt-2">Choose a patient from the list on the left to view and send messages.</p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function loadConversation(patientId) {
        // AJAX call to load conversation with the selected patient
        // Update the message history and conversation header
        console.log("Loading conversation for patient ID:", patientId);
    }

    function scheduleAppointment(patientId) {
        // AJAX call to open appointment scheduling modal or redirect to appointment page
        console.log("Scheduling appointment for patient ID:", patientId);
    }

    document.getElementById('messageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const message = document.getElementById('messageInput').value;
        if (message.trim()) {
            // AJAX call to send the message
            // On success, append the message to the message history
            appendMessage(message, 'doctor');
            document.getElementById('messageInput').value = '';
        }
    });

    function appendMessage(content, sender) {
        const messageHistory = document.getElementById('messageHistory');
        const messageElement = document.createElement('div');
        messageElement.className = `flex ${sender === 'doctor' ? 'justify-end' : ''}`;
        messageElement.innerHTML = `
            <div class="max-w-xs md:max-w-md ${sender === 'doctor' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'} rounded-lg p-3">
                <p>${content}</p>
                <p class="text-xs text-right mt-1 ${sender === 'doctor' ? 'text-blue-200' : 'text-gray-500'}">${new Date().toLocaleTimeString()}</p>
            </div>
        `;
        messageHistory.appendChild(messageElement);
        messageHistory.scrollTop = messageHistory.scrollHeight;
    }

    document.getElementById('patientSearch').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const patientList = document.getElementById('patientList');
        const patients = patientList.getElementsByTagName('div');
        
        for (let i = 0; i < patients.length; i++) {
            const patientName = patients[i].getElementsByTagName('p')[0].textContent.toLowerCase();
            if (patientName.includes(searchTerm)) {
                patients[i].style.display = "";
            } else {
                patients[i].style.display = "none";
            }
        }
    });
</script>
{% endblock %}