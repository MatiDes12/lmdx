{% extends 'doctors/base.html' %}

{% block title %}Message Doctor{% endblock %}

{% block sidebar %}
{% include 'doctors/sidebar.html' %}
{% endblock %}
{% block navbar %}
{% include 'doctors/dashboard_navbar.html' %}
{% endblock %}

{% block content %}
<div class="px-6 py-4 bg-gray-100 min-h-screen">
  <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 p-6 rounded-lg mb-6 text-white">
    <h1 class="text-3xl font-bold text-white">Your Messages</h1>
    <p class="text-white text-sm mt-2">Communicate with your clients securely and conveniently.</p>
  </div>
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2 bg-white p-6 rounded-lg mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Send a Message</h2>
      <form id="message-form">
        <div class="mb-6">
          <label for="client-select" class="block text-sm font-medium text-gray-700 mb-2">Choose your client:</label>
          <select id="client-select" name="client_id" class="w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg bg-gray-50 text-gray-700" required>
            <option value="">Select a client</option>
            {% for client in all_clients %}
              <option value="{{ client.client_id }}">{{ client.first_name }} {{ client.last_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div id="message-display" class="mb-6 bg-gray-50 p-4 rounded-lg h-64 overflow-y-auto">
          <!-- Message display area -->
        </div>
        <div class="mb-6">
          <label for="message" class="block text-sm font-medium text-gray-700 mb-2">Your Message:</label>
          <textarea id="message" name="message" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 mt-1 block w-full sm:text-sm border border-gray-300 rounded-lg p-4 bg-gray-50 h-24" placeholder="Type your message here..." required></textarea>
        </div>
        <button type="submit" class="w-full inline-flex items-center justify-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
          Send Message
          <svg class="ml-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
          </svg>
        </button>
      </form>
    </div>

    <div class="lg:col-span-1 bg-white p-6 rounded-lg mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">Message History</h2>
      <div class="relative mb-4">
        <input type="text" id="search-messages" placeholder="Search messages..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>

      <div id="message-history" class="overflow-y-auto max-h-96 space-y-4">
        {% for client in unique_clients %}
          <div class="message-preview p-4 bg-gray-100 rounded-lg cursor-pointer" data-client-id="{{ client['client_id'] }}">
            <p class="text-sm font-medium">{{ client['client_name'] }}</p>
            <p class="text-xs text-gray-400">{{ client['timestamp'] }}</p>
            <p class="text-sm text-gray-500">{{ client['last_message'] }}</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<style>
  .message {
    max-width: 75%;
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 10px;
  }
  .sender-message {
    background-color: #f0f0f0;
    text-align: left;
    margin-right: auto;
    font-size: 1.6rem; 
    font-weight: bold; /* Make the text bold */
    color: rgb(0, 0, 0); /* Make the text white */
  }
  .receiver-message {
    background-color: #0762c4b0;
    text-align: right;
    margin-left: auto;
    font-size: 1.6rem; /* Increase the font size */
    font-weight: bold; /* Make the text bold */
    color: white; /* Make the text white */
  }
  </style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const messageHistoryContainer = document.getElementById('message-history');

    messageHistoryContainer.addEventListener('click', function(event) {
        const targetElement = event.target.closest('.message-preview[data-client-id]');
        if (targetElement) {
            const clientId = targetElement.getAttribute('data-client-id');
            if (clientId) {
                loadConversation(clientId);
                selectClientInDropdown(clientId); // Function to select the client in the dropdown
            } else {
                alert("Client ID is undefined!");
            }
        }
    });

    function loadConversation(clientId) {
        fetch(`/doctor/get_messages?client_id=${clientId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const messageContainer = document.getElementById('message-display');
                    messageContainer.innerHTML = '';
                    data.conversation.forEach(msg => {
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${msg.sender === 'You' ? 'receiver-message' : 'sender-message'}`;
                        messageElement.innerHTML = `<p class="text-lg font-medium text-gray-800">${msg.sender}</p><p class="text-sm text-gray-600">${msg.message}</p><p class="text-xs text-gray-400">${msg.timestamp}</p>`;
                        messageContainer.appendChild(messageElement);
                    });
                } else {
                    alert('Failed to load messages.');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('An error occurred. Please try again.');
            });
    }

    function selectClientInDropdown(clientId) {
        const selectElement = document.getElementById('client-select');
        selectElement.value = clientId;
    }
});

document.addEventListener('DOMContentLoaded', () => {
    const sender = '{{ session["user_id"] }}';

    document.getElementById('client-select').addEventListener('change', function() {
        const receiver = this.value;
        fetch(`/doctor/get_messages?client_id=${receiver}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const messageContainer = document.getElementById('message-display');
                    messageContainer.innerHTML = '';
                    data.conversation.forEach(msg => {
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${msg.sender === 'You' ? 'receiver-message' : 'sender-message'}`;
                        messageElement.innerHTML = `<p class="text-lg font-medium text-gray-800">${msg.sender}</p><p class="text-sm text-gray-600">${msg.message}</p><p class="text-xs text-gray-400">${msg.timestamp}</p>`;
                        messageContainer.appendChild(messageElement);
                    });
                } else {
                    alert('Failed to load messages.');
                }
            });
    });

    document.getElementById('message-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const messageInput = document.getElementById('message');
        const receiver = document.getElementById('client-select').value;
        const message = messageInput.value;
        if (message.trim() !== '') {
          fetch('/doctor/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    client_id: receiver,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const messageContainer = document.getElementById('message-display');
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message receiver-message';
                    messageElement.innerHTML = `<p class="text-lg font-medium text-gray-800">You</p><p class="text-sm text-gray-600">${message}</p>`;
                    messageContainer.appendChild(messageElement);
                    messageInput.value = '';
                } else {
                    console.error('Error response:', data);
                    alert('Failed to send message. Please try again.');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('An error occurred. Please try again.');
            });
        }
    });

    document.getElementById('search-messages').addEventListener('input', function() {
        const query = this.value.toLowerCase();
        document.querySelectorAll('.message-preview').forEach(function(message) {
            const clientName = message.querySelector('.text-sm.font-medium').textContent.toLowerCase();
            const messageBody = message.querySelector('.text-sm.text-gray-500').textContent.toLowerCase();
            if (clientName.includes(query) || messageBody.includes(query)) {
                message.style.display = 'block';
            } else {
                message.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}
